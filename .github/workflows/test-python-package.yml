name: Test

on:
  pull_request:
    branches:
      - main
  push:
    tags:
      - '*'

  schedule:
    - cron: '0 0 * * *'

env:
  CACHE_NUMBER: 1  # increase to reset cache manually

jobs:
  build:
    runs-on: ubuntu-latest        
    steps:
      - uses: actions/checkout@v3

      - name: Get current date
        id: date
        run: echo "date=$(date +%Y-%m-%d)" >> "${GITHUB_OUTPUT}"
      - uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: environment.yml
          environment-name: my-env
          # persist on the same day.
          cache-environment-key: environment-${{ hashFiles('**/pyproject.toml') }}-${{ steps.date.outputs.date }}
          cache-downloads-key: downloads-${{ steps.date.outputs.date }}
          init-shell: bash

      - name: Lint with flake8
        shell: bash -l {0}
        run: |
          # stop the build if there are Python syntax errors or undefined names
          # Ignore scripts folder as mainly archived scripts
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude ./scripts
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude ./scripts

      - name: Install tinytex
        shell: bash -l {0}
        run: quarto install tinytex
        
      - name: Run document-issue tests
        working-directory: ./packages/document-issue
        shell: bash -l {0}
        run: pytest ./tests
        
      - name: Run document-issue-quarto tests
        working-directory: ./packages/document-issue-quarto
        shell: bash -l {0}
        run: pytest ./tests

      - name: Run document-issue-io tests
        working-directory: ./packages/document-issue-io
        shell: bash -l {0}
        run: pytest ./tests

      - name: Run document-issue-api tests
        working-directory: ./packages/document-issue-api
        shell: bash -l {0}
        run: pytest ./tests
